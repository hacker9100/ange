define(["controller/controllers"],function(controllers){controllers.controller("content_edit",["$scope","$sce","$stateParams","$location","$modal","$q","dialogs","UPLOAD",function($scope,$sce,$stateParams,$location,$modal,$q,dialogs,UPLOAD){$scope.click_selectTemplet=function(item){var blankSpace='<p><img class="template_handle" src="'+UPLOAD.BASE_URL+'/imgs/template_handler.jpg" style="width:260px; height:14px;"/></p>';switch(item){case "handler_template":if(!angular.isUndefined(CKEDITOR)){element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "basic_template":var temp='<div class="story-row previewwrap">'+'<div id="inBodyForm" class="story-col-xs-12 article_previewwrap">'+blankSpace+"</div>"+'<div class="hiddenline">'+$scope.item.BODY;"</div>"+"</div>";$scope.item.BODY=temp;break;case "plantitle_template":var temp="<plantitle>"+"<strong>\uc139\uc158\uba85</strong> | \uc81c\ubaa9"+"</plantitle>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "byline_template":var temp="<byline>"+'<div id="basic_information" class="basic_information">'+"<strong>\ud504\ub85c\uc81d\ud2b8 [\ud638\uc81c]</strong> 2014-12-25"+"</div>"+"<strong>\uc5d0\ub514\ud130</strong> \uc774\ub984 / <strong>\ud3ec\ud1a0\uadf8\ub798\ud37c</strong> \uc774\ub984 / <strong>\ucc38\uace0\ud55c \ucc45</strong> &lt;\uc81c\ubaa9&gt; &lt;\uc81c\ubaa9&gt; / <strong>\uc758\uc0c1 \ud611\ucc2c</strong> \uc5c5\uccb4(02-1234-5678, www.homepage.co.kr) / <strong>\ubaa8\ub378</strong> \uc774\ub984"+"</byline>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "headline_template":var temp1="<subtitle>"+"\uc18c\uc81c\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694"+"</subtitle>";var temp2="<maintitle>"+"\ub300\uc81c\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694"+"</maintitle>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp1);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(temp2);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "preface_basic_template":var temp1='<div class="imagebox"><img class="template_handle" src="'+UPLOAD.BASE_URL+'/imgs/image_handler.jpg" style="float:none; width:260px; height:14px; margin:0px auto;"/></div>';var temp2="<preface>"+"\uc804\ubb38 \ub0b4\uc6a9\uc744 \uc785\ub825\ud558\uc138\uc694"+"</preface>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp1);CKEDITOR.instances.editor1.insertElement(element);var element=CKEDITOR.dom.element.createFromHtml(temp2);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "sectionmain_template":var temp="<sectionmain>"+"\uc8fc\uc81c\ub97c \uc785\ub825\ud558\uc138\uc694"+"</sectionmain>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "sectionsub_template":var temp="<sectionsub>"+"\uc18c\uc8fc\uc81c\ub97c \uc785\ub825\ud558\uc138\uc694"+"</sectionsub>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "bodyscript_template":var temp="<bodyscript>"+"\ubcf8\ubb38 \ub0b4\uc6a9\uc744 \uc785\ub825\ud558\uc138\uc694"+"</bodyscript>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "bodyscript_p2b_template":var temp='<div class="story-row">'+'<div class="story-col-sm-6">'+'<div class="imagebox"><img class="template_handle" src="'+UPLOAD.BASE_URL+'/imgs/image_handler.jpg" style="float:none; width:260px; height:14px; margin:0px auto;"/></div>'+"<mediacaption>\uc774\ubbf8\uc9c0 \uc124\uba85\uc744 \uc785\ub825\ud558\uc138\uc694</mediacaption>"+"</div>"+'<div class="story-col-sm-6">'+"<bodyscript>\ubcf8\ubb38 \ub0b4\uc6a9\uc744 \uc785\ub825\ud558\uc138\uc694</bodyscript>"+"</div>"+"</div>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "bodyscript_b2p_template":var temp='<div class="story-row">'+'<div class="story-col-sm-6">'+"<bodyscript>\ubcf8\ubb38 \ub0b4\uc6a9\uc744 \uc785\ub825\ud558\uc138\uc694</bodyscript>"+"</div>"+'<div class="story-col-sm-6">'+'<div class="imagebox"><img class="template_handle" src="'+UPLOAD.BASE_URL+'/imgs/image_handler.jpg" style="float:none; width:260px; height:14px; margin:0px auto;"/></div>'+"<mediacaption>\uc774\ubbf8\uc9c0 \uc124\uba85\uc744 \uc785\ub825\ud558\uc138\uc694</mediacaption>"+"</div>"+"</div>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "tips_template":var temp="<tips>"+'<div class="tip_title">'+"TIP \uc81c\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694"+"</div>"+"\ub0b4\uc6a9\uc744 \uc785\ub825\ud558\uc138\uc694."+"</tips>";if(!angular.isUndefined(CKEDITOR)){var element=CKEDITOR.dom.element.createFromHtml(temp);CKEDITOR.instances.editor1.insertElement(element);element=CKEDITOR.dom.element.createFromHtml(blankSpace);CKEDITOR.instances.editor1.insertElement(element)}break;case "2E":var temp='<div class="story-row"> '+'<div class="story-col-sm-2" style="width:700px; height:500px; border:1px dashed; "></div>'+'<div class= "story-col-sm-2" style="width:700px; height:300px; border:1px dashed; ">'+$scope.item.BODY;"</div>"+"</div>";$scope.item.BODY=temp;break;case "2F":break}};$scope.renderHtml=function(html_code){return $sce.trustAsHtml(html_code)};$scope.queue=[];$scope.init=function(){};$scope.$on("ckeditor.ready",function(event){$scope.isReady=true});$scope.ckeditor="<p>\n<p>";$scope.click_showContentList=function(){$location.path("/"+$stateParams.menu+"/list")};$scope.click_showGetHistory=function(key){$scope.openHistoryModal({TASK_NO:key},"lg")};$scope.openHistoryModal=function(item,size){var dlg=dialogs.create("/partials/cms/history.html",function($scope,$controller,$modalInstance,data){angular.extend(this,$controller("cms_common",{$scope:$scope}));$scope.getList("cms/history","list",{},item,true).then(function(data){$scope.list=data})["catch"](function(error){console.log(error)});$scope.list=data;$scope.click_ok=function(){$modalInstance.close()}},item,{size:size,keyboard:true});dlg.result.then(function(){},function(){})};$scope.getTask=function(){var deferred=$q.defer();$q.all([$scope.getItem("cms/task","item",$stateParams.id,{},false).then(function(data){console.log(data);$scope.task=data}),$scope.getItem("cms/content","item",$stateParams.id,{},false).then(function(data){$scope.item=data;var files=data.FILES;for(var i in files)$scope.queue.push({"name":files[i].FILE_NM,"size":files[i].FILE_SIZE,"url":UPLOAD.BASE_URL+files[i].PATH+files[i].FILE_ID,"thumbnailUrl":UPLOAD.BASE_URL+files[i].PATH+"thumbnail/"+files[i].FILE_ID,"mediumUrl":UPLOAD.BASE_URL+files[i].PATH+"medium/"+files[i].FILE_ID,"deleteUrl":"http://localhost/serverscript/upload/?file="+files[i].FILE_NM,"deleteType":"DELETE"})})]).then(function(results){deferred.resolve()},function(error){deferred.reject(error)});return deferred.promise};$scope.click_saveContent=function(){$scope.item.TASK=$scope.task;$scope.item.FILES=$scope.queue;for(var i in $scope.item.FILES){$scope.item.FILES[i].$destroy="";$scope.item.FILES[i].$editor=""}if($scope.item.NO==undefined){$scope.item.PHASE="10";$scope.insertItem("cms/content","new",$scope.item,false).then(function(){dialogs.notify("\uc54c\ub9bc","\uc815\uc0c1\uc801\uc73c\ub85c \ub4f1\ub85d\ub418\uc5c8\uc2b5\ub2c8\ub2e4.",{size:"md"});$scope.task.PHASE="10"})["catch"](function(error){dialogs.error("\uc624\ub958",error+"",{size:"md"})})}else if($scope.task.PHASE=="20"&&$scope.item.PHASE!=$scope.task.PHASE)$scope.insertItem("cms/content","version",$scope.item,false).then(function(){dialogs.notify("\uc54c\ub9bc","\uc815\uc0c1\uc801\uc73c\ub85c \ub4f1\ub85d\ub418\uc5c8\uc2b5\ub2c8\ub2e4.",{size:"md"})})["catch"](function(error){dialogs.error("\uc624\ub958",error+"",{size:"md"})});else $scope.updateItem("cms/content","item",$scope.item.NO,$scope.item,false).then(function(){dialogs.notify("\uc54c\ub9bc","\uc815\uc0c1\uc801\uc73c\ub85c \uc218\uc815\ub418\uc5c8\uc2b5\ub2c8\ub2e4.",{size:"md"})})["catch"](function(error){dialogs.error("\uc624\ub958",error+"",{size:"md"})})};$scope.click_commitContent=function(){if($scope.task.PHASE=="0"){alert("\uc6d0\uace0\ub97c \ub4f1\ub85d\ud574 \uc8fc\uc138\uc694.");return}var phase="";if($scope.task.PHASE=="10"||$scope.task.PHASE=="11"||$scope.task.PHASE=="12")phase="11";else phase="21";$scope.updateStatus("cms/task","status",$scope.task.NO,phase,false).then(function(){$location.url("/"+$stateParams.menu+"/list")})["catch"](function(error){dialogs.error("\uc624\ub958",error+"",{size:"md"})})};$scope.click_returnContent=function(){var status="";if($scope.task.PHASE=="11")status="11";else status="21";$scope.openApprovalModal($scope.item,status)};$scope.click_approveContent=function(){var status="";if($scope.task.PHASE=="11")status="12";else status="22";$scope.openApprovalModal($scope.item,status)};$scope.openApprovalModal=function(content,status,size){var modalInstance=$modal.open({templateUrl:"content_approval_modal.html",controller:"content_approval_modal",size:size,resolve:{content:function(){return content},status:function(){return status}}});modalInstance.result.then(function(approval){},function(){console.log("\uacb0\uc7ac \uc624\ub958")})};$scope.click_showPreview=function(){$scope.openModal2($scope.item.BODY,"lg")};$scope.openModal2=function(content,size){var dlg=dialogs.create("preview_modal.html",function($scope,$modalInstance,data){$scope.content=data;$scope.click_ok=function(){$modalInstance.close()}},content,{size:size,keyboard:true,backdrop:false},$scope);dlg.result.then(function(){},function(){if(angular.equals($scope.name,""))$scope.name="You did not enter in your name!"})};$scope.initUpdate=function(){if($stateParams.id!=0)$scope.getTask()};if($stateParams.menu=="article"||$stateParams.menu=="edit"){$scope.isCommit=true;$scope.isApproval=false}else if($stateParams.menu=="article_confirm"||$stateParams.menu=="edit_confirm"){$scope.isCommit=false;$scope.isApproval=true}if($stateParams.menu=="edit"||$stateParams.menu=="edit_confirm")$scope.isTemplet=true;$scope.getSession().then($scope.sessionCheck).then($scope.permissionCheck).then($scope.init).then($scope.initUpdate)["catch"]($scope.reportProblems)}]);controllers.controller("content_approval_modal",["$scope","$stateParams","$modalInstance","dataService","content","status","$location",function($scope,$stateParams,$modalInstance,dataService,content,status,$location){if(status=="12"||status=="22")$scope.title="\uc2b9\uc778 \ucc98\ub9ac";else $scope.title="\ubc18\ub824 \ucc98\ub9ac";$scope.approval={};$scope.approval.TASK_NO=content.TASK_NO;$scope.approval.CONTENT_NO=content.NO;$scope.approval.APPROVAL_ST=status;$scope.click_ok=function(){dataService.db("com/approval").insert("item",$scope.approval,function(data, status){if(status!=200)alert("\uacb0\uc7ac\uc5d0 \uc2e4\ud328 \ud588\uc2b5\ub2c8\ub2e4.");else{console.log(JSON.stringify(data));if(!data.err){$location.url("/"+$stateParams.menu+"/list");$modalInstance.dismiss()}else alert(data.msg)}})};$scope.click_cancel=function(){$modalInstance.dismiss("cancel")}}])});