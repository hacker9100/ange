define(["controller/controllers"],function(controllers){controllers.controller("task_edit",["$scope","$stateParams","$location","$controller","$q","$modal","dialogs","$filter",function($scope,$stateParams,$location,$controller,$q,$modal,dialogs,$filter){$scope.item={};$scope.CATEGORY=[];$scope.category=[];$scope.select_settings={externalIdProp:"",idProp:"NO",displayProp:"CATEGORY_NM",dynamicTitle:false,showCheckAll:false,showUncheckAll:false};var year=[];var now=new Date;var nowYear=now.getFullYear();$scope.init=function(){for(var i=nowYear-5;i<nowYear+5;i++)year.push(i+"");$scope.years=year;$scope.YEAR=nowYear+"";var deferred=$q.defer();$q.all([$scope.getList("cms/category","list",{},{},false).then(function(data){$scope.category=data;var category_a=[];var category_b=[];for(var i in data){var item=data[i];if(item.CATEGORY_GB=="1"&&item.CATEGORY_ST=="0")category_a.push(item);else if(item.CATEGORY_GB=="2"&&item.CATEGORY_ST=="0"&&item.PARENT_NO=="0")category_b.push(item)}$scope.category_a=category_a;$scope.category_b=category_b}),$scope.getList("cms/section","list",{},{ROLE:true},false).then(function(data){$scope.seasons=data}),$scope.getList("cms/section","list",{},{},false).then(function(data){$scope.sections=data})]).then(function(results){deferred.resolve()},function(error){deferred.reject(error)});$scope.format="yyyy-MM-dd";$scope.today=function(){$scope.item.CLOSE_YMD=new Date;$scope.item.DEPLOY_YMD=new Date};$scope.today();$scope.clear=function(){$scope.item.CLOSE_YMD=null};$scope.open=function($event,opened){$event.preventDefault();$event.stopPropagation();$scope[opened]=true};return deferred.promise};$scope.$watch("CATEGORY_M",function(data){var category_s=[];if(data!=undefined)for(var i in $scope.category){var item=$scope.category[i];if(item.PARENT_NO==data.NO&&item.CATEGORY_GB=="2"&&item.CATEGORY_ST=="0"&&item.PARENT_NO!="0")category_s.push(item)}$scope.category_s=category_s});$scope.click_removeCategory=function(idx){$scope.CATEGORY.splice(idx,1)};$scope.$watch("YEAR",function(data){if(data!=null)$scope.getList("cms/project","list",{},{YEAR:data},false).then(function(data){$scope.projects=data;if($scope.item.PROJECT_NO!=undefined)angular.forEach($scope.projects,function(value,idx){if(value.NO==$scope.item.PROJECT_NO){$scope.item.PROJECT=$scope.projects[idx];return}})})["catch"](function(error){console.log(error)})});$scope.click_showTaskList=function(){$location.path("/task/list")};$scope.getTask=function(){$scope.getItem("cms/task","item",$stateParams.id,{},true).then(function(data){$scope.item=data;if(data.CATEGORY!=null)$scope.CATEGORY=angular.fromJson(data.CATEGORY);$scope.YEAR=data.YEAR;var idx=0;for(var i=0;i<$scope.seasons.length;i++)if(JSON.stringify(data.SEASON_NM)==JSON.stringify($scope.seasons[i].SEASON_NM))idx=i;$scope.item.SEASON_NM=$scope.seasons[idx];var idx=0;for(var i=0;i<$scope.sections.length;i++)if(JSON.stringify(data.SECTION_NM)==JSON.stringify($scope.sections[i].SECTION_NM))idx=i;$scope.item.SECTION=$scope.sections[idx]})["catch"](function(error){dialogs.error("\uc624\ub958",error+"",{size:"md"})})};$scope.$watch("item.SEASON_NM",function(data){if(data!=null)$scope.getList("cms/section","list",{},{SEASON_NM:data.SEASON_NM},false).then(function(data){$scope.sections=data;if($stateParams.id==0)$scope.item.SECTION=data[0];else for(var i=0;i<$scope.sections.length;i++)if(JSON.stringify($scope.item.SECTION.SECTION_NM)==JSON.stringify($scope.sections[i].SECTION_NM))$scope.item.SECTION=$scope.sections[i]})["catch"](function(error){dialogs.error("\uc624\ub958",error+"",{size:"md"})});else $scope.getList("cms/section","list",{},{},false).then(function(data){$scope.sections=data})});$scope.click_saveTask=function(){$scope.item.CATEGORY=$scope.CATEGORY;$scope.item.CLOSE_YMD=$filter("date")($scope.item.CLOSE_YMD,"yyyy-MM-dd");if($stateParams.id==0)$scope.insertItem("cms/task","item",$scope.item,false).then(function(){$location.url("/task/list")})["catch"](function(error){dialogs.error("\uc624\ub958",error+"",{size:"md"})});else $scope.updateItem("cms/task","item",$stateParams.id,$scope.item,false).then(function(){$location.url("/task/list")})["catch"](function(error){dialogs.error("\uc624\ub958",error+"",{size:"md"})})};$scope.initUpdate=function(){if($stateParams.id!=0)$scope.getTask()};$scope.click_selectEditor=function(){$scope.openModal(true,{ROLE_ID:"IN_EDITOR, OUT_EDITOR"})};$scope.openModal=function(modal,search,size){var dlg=dialogs.create("/partials/cms/contact_list.html","contact_list_modal",search,{size:size,keyboard:true},$scope);dlg.result.then(function(user){$scope.item.EDITOR_ID=user.USER_ID;$scope.item.EDITOR_NM=user.USER_NM},function(){})};$scope.getSession().then($scope.sessionCheck).then($scope.permissionCheck).then($scope.init).then($scope.initUpdate)["catch"]($scope.reportProblems)}])});