define(["controller/controllers"],function(controllers){controllers.controller("task_list",["$scope","$rootScope","$stateParams","$location","dialogs","COMMON",function($scope,$rootScope,$stateParams,$location,dialogs,COMMON){$scope.listData=[];$scope.search={};$scope.CATEGORY=[];$scope.category=[];$scope.select_settings={externalIdProp:"",idProp:"NO",displayProp:"CATEGORY_NM",dynamicTitle:false,showCheckAll:false,showUncheckAll:false};var year=[];var now=new Date;var nowYear=now.getFullYear();$scope.init=function(){$scope.oneAtATime=true;for(var i=nowYear-5;i<nowYear+5;i++)year.push(i+"");var ret=$scope.getList("cms/category","list",{},{},false).then(function(data){$scope.category=data;var category_a=[];var category_b=[];for(var i in data){var item=data[i];if(item.CATEGORY_GB=="1"&&item.CATEGORY_ST=="0")category_a.push(item);else if(item.CATEGORY_GB=="2"&&item.CATEGORY_ST=="0"&&item.PARENT_NO=="0")category_b.push(item)}$scope.category_a=category_a;$scope.category_b=category_b})["catch"](function(error){console.log(error)});var condition=[{name:"\uae30\uc790",value:"EDITOR_NM"},{name:"\uc81c\ubaa9+\ub0b4\uc6a9",value:"SUBJECT"}];$scope.years=year;$scope.condition=condition;$scope.search.CONDITION=condition[0];return ret};$scope.$watch("CATEGORY_M",function(data){var category_s=[];if(data!=undefined)for(var i in $scope.category){var item=$scope.category[i];if(item.PARENT_NO==data.NO&&item.CATEGORY_GB=="2"&&item.CATEGORY_ST=="0"&&item.PARENT_NO!="0")category_s.push(item)}$scope.category_s=category_s});$scope.click_removeCategory=function(idx){$scope.CATEGORY.splice(idx,1)};$scope.$watch("search.YEAR",function(data){if(data!=null)$scope.getList("cms/project","list",{},{YEAR:data},false).then(function(data){$scope.projects=data})["catch"](function(error){$scope.projects=[];console.log(error)})});$scope.click_createNewTask=function(){$location.url("/task/edit/0")};$scope.click_showViewTask=function(key){$location.url("/task/view/"+key)};$scope.click_showEditTask=function(item){if(!($rootScope.role=="CMS_ADMIN"||$rootScope.role=="MANAGER")&&$rootScope.uid!=item.REG_UID){dialogs.notify("\uc54c\ub9bc","\uc218\uc815 \uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.",{size:"md"});return}$location.url("/task/edit/"+item.NO)};$scope.click_showViewContent=function(key){$location.url("/"+$stateParams.menu+"/view/"+key)};$scope.click_showEditContent=function(item){if(!($rootScope.role=="CMS_ADMIN"||$rootScope.role=="MANAGER"||$rootScope.role=="MAGAZINE")&&$rootScope.uid!=item.EDITOR_ID){dialogs.notify("\uc54c\ub9bc","\uc218\uc815 \uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.",{size:"md"});return}$location.url("/"+$stateParams.menu+"/edit/"+item.NO)};$scope.click_showGetHistory=function(key){$scope.openModal({TASK_NO:key},"lg")};$scope.openModal=function(item,size){var dlg=dialogs.create("/partials/cms/history.html",function($scope,$controller,$modalInstance,data){angular.extend(this,$controller("cms_common",{$scope:$scope}));$scope.getList("cms/history","list",{},item,true).then(function(data){$scope.list=data})["catch"](function(error){console.log(error)});$scope.list=data;$scope.click_ok=function(){$modalInstance.close()}},item,{size:size,keyboard:true});dlg.result.then(function(){},function(){})};$scope.click_deleteTask=function(idx){var task=$scope.list[idx];if(task.PHASE=="30"){dialogs.notify("\uc54c\ub9bc","\uc644\ub8cc \uc0c1\ud0dc\uc758 \ud0dc\uc2a4\ud06c\ub294 \uc0ad\uc81c\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4.",{size:"md"});return}$scope.deleteItem("cms/task","item",task.NO,true).then(function(){dialogs.notify("\uc54c\ub9bc","\uc0ad\uc81c \ub418\uc5c8\uc2b5\ub2c8\ub2e4.",{size:"md"})})["catch"](function(error){dialogs.error("\uc624\ub958",error+"",{size:"md"})})};$scope.PAGE_SIZE=10;$scope.list=[];$scope.pageNo=0;$scope.pageSize=$scope.PAGE_SIZE;$scope.perCnt=0;$scope.perSize=$scope.PAGE_SIZE/2;$scope.totalCnt=0;$scope.click_searchTask=function(){$scope.list=[];$scope.listData=[];$scope.pageNo=0;$scope.perCnt=0;$scope.search.CATEGORY=$scope.CATEGORY;$scope.getTaskList()};$scope.getTaskList=function(){$scope.isLoading=true;$scope.getList("cms/task","list",{NO:$scope.pageNo,SIZE:$scope.pageSize},$scope.search,true).then(function(data){var total_cnt=data[0].TOTAL_COUNT;$scope.TOTAL_COUNT=total_cnt;$scope.totalCnt=total_cnt;angular.forEach(data,function(model){$scope.listData.push(model)});if($scope.list.length==0)$scope.list=$scope.listData.slice($scope.perCnt,$scope.perSize)})["catch"](function(error){$scope.TOTAL_COUNT=0;console.log(error)})["finally"](function(){$scope.isLoading=false})};$scope.$watch("perCnt",function(){if($scope.perCnt>=$scope.list.length)angular.forEach($scope.listData.slice($scope.perCnt,$scope.perCnt+$scope.perSize),function(model){$scope.list.push(model)})});$scope.addTask=function(){$scope.perCnt+=$scope.perSize;if($scope.perCnt+$scope.perSize>=$scope.totalCnt)return;if($scope.perCnt+$scope.perSize>=$scope.listData.length){$scope.pageNo++;$scope.getTaskList()}};$scope.isTask=false;$scope.isEdit=true;if($stateParams.menu=="archive"){$scope.search={PHASE:"31"};$scope.isTask=false;$scope.isEdit=false;$scope.viewContentBtn="\uc6d0\uace0 \uc870\ud68c";$scope.editContentBtn="\uc6d0\uace0 \uc791\uc131"}else if($stateParams.menu=="article"){$scope.search={PHASE:"0, 10, 11, 12"};$scope.viewContentBtn="\uc6d0\uace0 \uc870\ud68c";$scope.editContentBtn="\uc6d0\uace0 \uc791\uc131"}else if($stateParams.menu=="article_confirm"){$scope.search={PHASE:"11, 12, 13"};$scope.viewContentBtn="\uc6d0\uace0 \uc870\ud68c";$scope.editContentBtn="\uc6d0\uace0 \uac80\uc218"}else if($stateParams.menu=="edit"){$scope.search={PHASE:"13, 20, 21, 22"};$scope.viewContentBtn="\ud3b8\uc9d1 \uc870\ud68c";$scope.editContentBtn="\ud3b8\uc9d1 \uc791\uc131"}else if($stateParams.menu=="edit_confirm"){$scope.search={PHASE:"21, 22, 30"};$scope.viewContentBtn="\ud3b8\uc9d1 \uc870\ud68c";$scope.editContentBtn="\ud3b8\uc9d1 \uac80\uc218"}else{$scope.isTask=true;$scope.search={};$scope.viewContentBtn="\uc6d0\uace0 \uc870\ud68c";$scope.editContentBtn="\uc6d0\uace0 \uc791\uc131"}$scope.getSession().then($scope.sessionCheck).then($scope.permissionCheck)["catch"]($scope.reportProblems);$scope.init();$scope.getTaskList()}])});